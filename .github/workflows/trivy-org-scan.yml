name: Trivy Organization Scan

on:
  schedule:
    - cron: '0 2 * * *'  # ÊØéÊó• AM 2:00 UTC (JST 11:00)
  workflow_dispatch:  # ÊâãÂãïÂÆüË°åÁî®

env:
  ORG_NAME: ${{ github.repository_owner }}

jobs:
  get-repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.list-repos.outputs.repos }}
    steps:
      - name: Get repository list
        id: list-repos
        env:
          GH_TOKEN: ${{ secrets.ORG_SCAN_TOKEN }}
        run: |
          repos=$(gh repo list "${{ env.ORG_NAME }}" --json name,isArchived --limit 500 \
            | jq -c '[.[] | select(.isArchived == false) | .name]')
          echo "repos=$repos" >> $GITHUB_OUTPUT
          echo "Found repositories:"
          echo "$repos" | jq -r '.[]'

  scan:
    needs: get-repos
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.get-repos.outputs.repos) }}
    steps:
      - name: Checkout ${{ matrix.repo }}
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ORG_NAME }}/${{ matrix.repo }}
          token: ${{ secrets.ORG_SCAN_TOKEN }}
          path: target-repo

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          curl -sfL -o html.tpl https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl

      - name: Run Trivy vulnerability scan (HTML)
        run: |
          trivy fs target-repo \
            --scanners vuln \
            --severity CRITICAL,HIGH,MEDIUM \
            --format template \
            --template "@html.tpl" \
            --output trivy-report.html || true

      - name: Run Trivy vulnerability scan (JSON for CVSS check)
        run: |
          trivy fs target-repo \
            --scanners vuln \
            --severity CRITICAL,HIGH,MEDIUM \
            --format json \
            --output trivy-report.json || true

      - name: Check for CVSS >= 8.0 vulnerabilities
        id: cvss-check
        run: |
          HIGH_CVSS=$(jq -r '
            [.Results[]?.Vulnerabilities[]? | 
              select(.CVSS != null) | 
              .CVSS | to_entries[] | .value.V3Score // .value.V2Score // 0
            ] | map(select(. >= 8.0)) | length
          ' trivy-report.json 2>/dev/null || echo "0")
          
          echo "high_cvss_count=$HIGH_CVSS" >> $GITHUB_OUTPUT
          
          if [ "$HIGH_CVSS" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $HIGH_CVSS vulnerabilities with CVSS >= 8.0 in ${{ matrix.repo }}"
            
            # Extract critical CVE details
            jq -r '
              .Results[]?.Vulnerabilities[]? | 
              select(.CVSS != null) |
              select((.CVSS | to_entries[] | .value.V3Score // .value.V2Score // 0) >= 8.0) |
              "\(.VulnerabilityID) | \(.PkgName) | \(.CVSS | to_entries[0] | .value.V3Score // .value.V2Score) | \(.Title // "N/A")"
            ' trivy-report.json > critical-cves.txt 2>/dev/null || true
          fi

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report-${{ matrix.repo }}
          path: trivy-report.html
          retention-days: 1

      - name: Upload critical CVEs if found
        if: steps.cvss-check.outputs.high_cvss_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: critical-cves-${{ matrix.repo }}
          path: critical-cves.txt
          retention-days: 1

  commit-reports:
    needs: scan
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          token: ${{ secrets.ORG_SCAN_TOKEN }}
          path: gh-pages
        continue-on-error: true

      - name: Initialize gh-pages if not exists
        run: |
          if [ ! -d "gh-pages" ]; then
            mkdir gh-pages
            cd gh-pages
            git init
            git checkout -b gh-pages
            git remote add origin "https://x-access-token:${{ secrets.ORG_SCAN_TOKEN }}@github.com/${{ github.repository }}.git"
          fi

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: temp-reports
          pattern: trivy-report-*

      - name: Download critical CVEs
        uses: actions/download-artifact@v4
        with:
          path: temp-critical
          pattern: critical-cves-*
        continue-on-error: true

      - name: Organize reports and update index
        run: |
          cd gh-pages
          
          SCAN_DATE=$(date -u '+%Y-%m-%d')
          SCAN_TIME=$(date -u '+%H%M%S')
          REPORT_DIR="reports/${SCAN_DATE}/${SCAN_TIME}"
          
          mkdir -p "$REPORT_DIR"
          
          for dir in ../temp-reports/trivy-report-*; do
            if [ -d "$dir" ]; then
              repo_name=$(basename "$dir" | sed 's/trivy-report-//')
              cp "$dir/trivy-report.html" "$REPORT_DIR/${repo_name}.html"
            fi
          done
          
          # Copy index.html template if not exists
          if [ ! -f "index.html" ]; then
            cat > index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Trivy Scan Reports</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
              .container { max-width: 1200px; margin: 0 auto; }
              h1 { color: #333; margin-bottom: 10px; }
              .last-updated { color: #666; margin-bottom: 30px; font-size: 14px; }
              .scan-group { background: #fff; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
              .scan-header { background: #2c3e50; color: #fff; padding: 15px 20px; border-radius: 8px 8px 0 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
              .scan-header:hover { background: #34495e; }
              .scan-header h2 { font-size: 18px; font-weight: 500; }
              .scan-header .time { font-size: 14px; opacity: 0.8; }
              .repo-list { padding: 0; display: none; }
              .repo-list.active { display: block; }
              .repo-item { padding: 12px 20px; border-bottom: 1px solid #eee; }
              .repo-item:last-child { border-bottom: none; }
              .repo-item a { color: #3498db; text-decoration: none; }
              .repo-item a:hover { text-decoration: underline; }
              .no-reports { text-align: center; padding: 60px 20px; color: #666; }
              .toggle-icon { transition: transform 0.2s; }
              .scan-header.open .toggle-icon { transform: rotate(180deg); }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üîç Trivy Scan Reports</h1>
              <p class="last-updated">Last updated: <span id="lastUpdated">-</span></p>
              <div id="reports"></div>
            </div>
            <script>
              const REPORTS_DATA = [];
              function render() {
                const container = document.getElementById('reports');
                if (REPORTS_DATA.length === 0) {
                  container.innerHTML = '<div class="no-reports">No scan reports yet.</div>';
                  return;
                }
                document.getElementById('lastUpdated').textContent = REPORTS_DATA[0]?.date + ' ' + REPORTS_DATA[0]?.time || '-';
                container.innerHTML = REPORTS_DATA.map((scan, i) => `
                  <div class="scan-group">
                    <div class="scan-header ${i === 0 ? 'open' : ''}" onclick="toggle(this)">
                      <h2>${scan.date}</h2>
                      <span class="time">${scan.time} UTC (${scan.repos.length} repos) <span class="toggle-icon">‚ñº</span></span>
                    </div>
                    <ul class="repo-list ${i === 0 ? 'active' : ''}">
                      ${scan.repos.map(r => `<li class="repo-item"><a href="${r.path}" target="_blank">${r.name}</a></li>`).join('')}
                    </ul>
                  </div>
                `).join('');
              }
              function toggle(el) {
                el.classList.toggle('open');
                el.nextElementSibling.classList.toggle('active');
              }
              render();
            </script>
          </body>
          </html>
          HTMLEOF
          fi
          
          # Generate REPORTS_DATA from reports directory
          echo "Generating index.html data..."
          REPORTS_JSON="["
          first_scan=true
          
          for date_dir in $(ls -r reports/ 2>/dev/null); do
            for time_dir in $(ls -r "reports/$date_dir/" 2>/dev/null); do
              if [ "$first_scan" = false ]; then
                REPORTS_JSON+=","
              fi
              first_scan=false
              
              REPOS_JSON="["
              first_repo=true
              for html_file in "reports/$date_dir/$time_dir"/*.html; do
                if [ -f "$html_file" ]; then
                  repo_name=$(basename "$html_file" .html)
                  if [ "$first_repo" = false ]; then
                    REPOS_JSON+=","
                  fi
                  first_repo=false
                  REPOS_JSON+="{\"name\":\"$repo_name\",\"path\":\"$html_file\"}"
                fi
              done
              REPOS_JSON+="]"
              
              REPORTS_JSON+="{\"date\":\"$date_dir\",\"time\":\"$time_dir\",\"repos\":$REPOS_JSON}"
            done
          done
          REPORTS_JSON+="]"
          
          # Update index.html with new data
          sed -i "s|const REPORTS_DATA = .*\];|const REPORTS_DATA = $REPORTS_JSON;|" index.html
          
          # Generate critical CVEs summary
          SCAN_DATE=$(date -u '+%Y-%m-%d')
          SCAN_TIME=$(date -u '+%H%M%S')
          CRITICAL_DIR="critical/${SCAN_DATE}"
          mkdir -p "$CRITICAL_DIR"
          
          echo "# Critical Vulnerabilities (CVSS >= 8.0)" > "$CRITICAL_DIR/${SCAN_TIME}.md"
          echo "" >> "$CRITICAL_DIR/${SCAN_TIME}.md"
          echo "Scan Time: ${SCAN_DATE} ${SCAN_TIME} UTC" >> "$CRITICAL_DIR/${SCAN_TIME}.md"
          echo "" >> "$CRITICAL_DIR/${SCAN_TIME}.md"
          
          has_critical=false
          for dir in ../temp-critical/critical-cves-*; do
            if [ -d "$dir" ] && [ -f "$dir/critical-cves.txt" ]; then
              repo_name=$(basename "$dir" | sed 's/critical-cves-//')
              echo "## $repo_name" >> "$CRITICAL_DIR/${SCAN_TIME}.md"
              echo "" >> "$CRITICAL_DIR/${SCAN_TIME}.md"
              echo "| CVE ID | Package | CVSS Score | Title |" >> "$CRITICAL_DIR/${SCAN_TIME}.md"
              echo "|--------|---------|------------|-------|" >> "$CRITICAL_DIR/${SCAN_TIME}.md"
              while IFS='|' read -r cve pkg score title; do
                echo "| $cve | $pkg | $score | $title |" >> "$CRITICAL_DIR/${SCAN_TIME}.md"
              done < "$dir/critical-cves.txt"
              echo "" >> "$CRITICAL_DIR/${SCAN_TIME}.md"
              has_critical=true
            fi
          done
          
          if [ "$has_critical" = false ]; then
            echo "No critical vulnerabilities found." >> "$CRITICAL_DIR/${SCAN_TIME}.md"
          fi
          
          # Output summary to console (for future notification)
          echo "=========================================="
          echo "CRITICAL VULNERABILITIES SUMMARY (CVSS >= 8.0)"
          echo "=========================================="
          cat "$CRITICAL_DIR/${SCAN_TIME}.md"

      - name: Commit to gh-pages
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Add Trivy scan reports - $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || echo "No changes to commit"
          git push origin gh-pages --force
