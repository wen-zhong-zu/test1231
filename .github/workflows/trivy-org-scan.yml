name: Trivy Organization Scan

on:
  schedule:
    - cron: '0 2 * * *'  # 毎日 AM 2:00 UTC (JST 11:00)
  workflow_dispatch:  # 手動実行用

env:
  ORG_NAME: ${{ github.repository_owner }}

jobs:
  get-repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.list-repos.outputs.repos }}
    steps:
      - name: Get repository list
        id: list-repos
        env:
          GH_TOKEN: ${{ secrets.ORG_SCAN_TOKEN }}
        run: |
          repos=$(gh repo list "${{ env.ORG_NAME }}" --json name,isArchived --limit 500 \
            | jq -c '[.[] | select(.isArchived == false) | .name]')
          echo "repos=$repos" >> $GITHUB_OUTPUT
          echo "Found repositories:"
          echo "$repos" | jq -r '.[]'

  scan:
    needs: get-repos
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.get-repos.outputs.repos) }}
    steps:
      - name: Checkout ${{ matrix.repo }}
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ORG_NAME }}/${{ matrix.repo }}
          token: ${{ secrets.ORG_SCAN_TOKEN }}
          path: target-repo

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          curl -sfL -o html.tpl https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl

      - name: Run Trivy vulnerability scan
        run: |
          trivy fs target-repo \
            --scanners vuln \
            --severity CRITICAL,HIGH,MEDIUM \
            --format template \
            --template "@html.tpl" \
            --output trivy-report.html || true

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report-${{ matrix.repo }}
          path: trivy-report.html
          retention-days: 1

  commit-reports:
    needs: scan
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ORG_SCAN_TOKEN }}

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: temp-reports
          pattern: trivy-report-*

      - name: Organize and commit reports
        run: |
          SCAN_DATE=$(date -u '+%Y-%m-%d')
          SCAN_TIME=$(date -u '+%H%M%S')
          REPORT_DIR="reports/${SCAN_DATE}/${SCAN_TIME}"
          
          mkdir -p "$REPORT_DIR"
          
          for dir in temp-reports/trivy-report-*; do
            if [ -d "$dir" ]; then
              repo_name=$(basename "$dir" | sed 's/trivy-report-//')
              cp "$dir/trivy-report.html" "$REPORT_DIR/${repo_name}.html"
            fi
          done
          
          rm -rf temp-reports
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/
          git commit -m "Add Trivy scan reports - ${SCAN_DATE} ${SCAN_TIME}" || echo "No changes to commit"
          git push
